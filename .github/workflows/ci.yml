name: ğŸ”„ CI - Continuous Integration

on:
  pull_request:
    branches:
      - develop
      - main
  push:
    branches:
      - develop
      - main

# Cancela workflows anteriores quando novo push Ã© feito
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # ğŸ“‹ JOB 1: ANÃLISE ESTÃTICA E LINT
  # ============================================
  analyze:
    name: ğŸ“Š AnÃ¡lise EstÃ¡tica e Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # NecessÃ¡rio para anÃ¡lise completa

      - name: â˜• Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Instalar dependÃªncias
        run: flutter pub get

      - name: ğŸ” AnÃ¡lise estÃ¡tica (flutter analyze)
        run: flutter analyze --fatal-infos --fatal-warnings

      - name: ğŸ“ Verificar arquivos gerados
        run: |
          if git diff --name-only | grep -E '\.(g|freezed)\.dart$'; then
            echo "âŒ Arquivos gerados nÃ£o estÃ£o atualizados!"
            echo "Execute: dart run build_runner build --delete-conflicting-outputs"
            exit 1
          fi

  # ============================================
  # ğŸ§ª JOB 2: TESTES UNITÃRIOS E DE INTEGRAÃ‡ÃƒO
  # ============================================
  test:
    name: ğŸ§ª Testes UnitÃ¡rios e IntegraÃ§Ã£o
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v6

      - name: â˜• Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Instalar dependÃªncias
        run: flutter pub get

      - name: ğŸ§ª Executar testes com cobertura
        run: flutter test --coverage --reporter expanded

      - name: ğŸ“Š Verificar cobertura mÃ­nima
        run: |
          if [ -f coverage/lcov.info ]; then
            COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')
            echo "ğŸ“Š Cobertura atual: $COVERAGE%"
            
            MIN_COVERAGE=70
            if (( $(echo "$COVERAGE < $MIN_COVERAGE" | bc -l) )); then
              echo "âŒ Cobertura abaixo do mÃ­nimo ($MIN_COVERAGE%)"
              exit 1
            else
              echo "âœ… Cobertura aceitÃ¡vel (>= $MIN_COVERAGE%)"
            fi
          else
            echo "âš ï¸  Arquivo de cobertura nÃ£o encontrado"
          fi

      - name: ğŸ“¤ Upload cobertura para Codecov (opcional)
        if: always()
        uses: codecov/codecov-action@v5
        with:
          files: coverage/lcov.info
          fail_ci_if_error: false
          # token: ${{ secrets.CODECOV_TOKEN }}

  # ============================================
  # ğŸ¤– JOB 3: BUILD ANDROID
  # ============================================
  # build-android:
  #   name: ğŸ¤– Build Android
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 30
  #   needs: [analyze, test]

  #   steps:
  #     - name: ğŸ“¥ Checkout cÃ³digo
  #       uses: actions/checkout@v6

  #     - name: â˜• Setup Java
  #       uses: actions/setup-java@v5
  #       with:
  #         distribution: 'temurin'
  #         java-version: '17'

  #     - name: ğŸ¦ Setup Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: '3.38.4'
  #         channel: 'stable'
  #         cache: true

  #     - name: ğŸ“¦ Instalar dependÃªncias
  #       run: flutter pub get

  #     - name: ğŸ”¨ Build APK (Debug)
  #       run: flutter build apk --debug --target-platform android-arm64

  #     - name: ğŸ“Š Verificar tamanho do APK
  #       run: |
  #         APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-debug.apk | cut -f1)
  #         echo "ğŸ“¦ Tamanho do APK: $APK_SIZE"

  #     - name: ğŸ“¤ Upload APK como artefato
  #       uses: actions/upload-artifact@v5
  #       with:
  #         name: android-apk-debug
  #         path: build/app/outputs/flutter-apk/app-debug.apk
  #         retention-days: 7

  # ============================================
  # ğŸ JOB 4: BUILD iOS (apenas em macOS)
  # ============================================
  # build-ios:
  #   name: ğŸ Build iOS
  #   runs-on: macos-latest
  #   timeout-minutes: 30
  #   needs: [analyze, test]
  #   if: github.event_name == 'pull_request' && (github.base_ref == 'main' || github.base_ref == 'develop')

  #   steps:
  #     - name: ğŸ“¥ Checkout cÃ³digo
  #       uses: actions/checkout@v6

  #     - name: ğŸ¦ Setup Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: '3.38.4'
  #         channel: 'stable'
  #         cache: true

  #     - name: ğŸ“¦ Instalar dependÃªncias
  #       run: flutter pub get

  #     - name: ğŸ“¦ Instalar CocoaPods
  #       run: |
  #         cd ios
  #         pod install

  #     - name: ğŸ”¨ Build iOS (sem assinatura)
  #       run: flutter build ios --no-codesign --debug

  #     - name: ğŸ“Š Verificar tamanho do build
  #       run: |
  #         IOS_SIZE=$(du -sh build/ios/iphoneos/Runner.app | cut -f1)
  #         echo "ğŸ“¦ Tamanho do build iOS: $IOS_SIZE"

  # ============================================
  # ğŸ”’ JOB 5: ANÃLISE DE SEGURANÃ‡A
  # ============================================
  security:
    name: ğŸ”’ AnÃ¡lise de SeguranÃ§a
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v6

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Instalar dependÃªncias
        run: flutter pub get

      - name: ğŸ” Verificar dependÃªncias desatualizadas
        run: flutter pub outdated || true

      - name: ğŸš¨ Verificar vulnerabilidades conhecidas
        run: |
          # Instala ferramenta de anÃ¡lise de seguranÃ§a
          dart pub global activate pana
          
          echo "ğŸ” Analisando seguranÃ§a do projeto..."
          # Aqui vocÃª pode adicionar ferramentas como Snyk, Trivy, etc.

      - name: ğŸ” Verificar exposiÃ§Ã£o de secrets
        run: |
          echo "ğŸ” Verificando se hÃ¡ secrets expostos no cÃ³digo..."
          
          # Verifica se hÃ¡ tokens ou chaves no cÃ³digo
          if grep -r -i -E "(api_key|apikey|secret|password|token|bearer)" --exclude-dir={.git,build,ios/Pods} --exclude="*.{yaml,md,lock,g.dart,freezed.dart}" .; then
            echo "âš ï¸  PossÃ­vel exposiÃ§Ã£o de secrets detectada!"
            echo "Revise os arquivos acima e certifique-se de que nÃ£o hÃ¡ credenciais expostas."
          else
            echo "âœ… Nenhum secret exposto detectado"
          fi

  # ============================================
  # âœ… JOB FINAL: STATUS CONSOLIDADO
  # ============================================
  ci-success:
    name: âœ… CI Pipeline Completo
    runs-on: ubuntu-latest
    needs: [analyze, test, security]
    if: always()

    steps:
      - name: ğŸ‰ Verificar sucesso de todos os jobs
        run: |
          if [ "${{ needs.analyze.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ]; then
            echo "âŒ Alguns jobs falharam"
            exit 1
          else
            echo "âœ… Todos os checks passaram com sucesso!"
            echo "ğŸš€ PR pronto para revisÃ£o"
          fi
